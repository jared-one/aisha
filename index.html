<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Catching You üíñ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #667eea 100%);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            overflow: hidden;
            height: 100vh;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        #ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .screen {
            display: none;
            text-align: center;
            max-width: 90%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
            pointer-events: all;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 0.5em;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            animation: pulse 2s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        p {
            font-size: 1.3em;
            margin: 0.5em 0;
            line-height: 1.6;
        }
        
        button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 15px 40px;
            margin: 10px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            font-weight: bold;
            pointer-events: all;
        }
        
        button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
        }
        
        button:active {
            transform: translateY(0) scale(0.98);
        }
        
        #score {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            z-index: 20;
            pointer-events: none;
        }
        
        #timer {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            z-index: 20;
            pointer-events: none;
        }
        
        #instructions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.3em;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 30px;
            border-radius: 20px;
            z-index: 20;
            pointer-events: none;
            max-width: 90%;
        }
        
        .choice-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .achievement {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
            animation: achievementPop 3s ease forwards;
            z-index: 30;
            display: none;
        }
        
        @keyframes achievementPop {
            0% { transform: translateX(-50%) translateY(-100px) scale(0); opacity: 0; }
            10% { transform: translateX(-50%) translateY(0) scale(1.1); opacity: 1; }
            90% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-100px) scale(0.8); opacity: 0; }
        }
        
        .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            p { font-size: 1.1em; }
            button { font-size: 1em; padding: 12px 30px; }
            #score, #timer { font-size: 1.3em; }
        }
        
        .hidden { display: none !important; }
        
        #typeInput {
            font-size: 1.5em;
            padding: 15px;
            border-radius: 15px;
            border: 3px solid #f093fb;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
            margin: 20px 0;
            width: 80%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="score">üíï <span id="lpScore">0</span></div>
    <div id="timer" class="hidden">‚è±Ô∏è <span id="timeLeft">0</span>s</div>
    <div id="instructions"></div>
    <div id="achievement" class="achievement"></div>
    
    <div id="ui">
        <!-- TITLE SCREEN -->
        <div id="titleScreen" class="screen active">
            <h1>üíñ Catching You üíñ</h1>
            <p>üéÇ Happy Birthday, Beautiful! üéÇ</p>
            <p class="subtitle">A love story & adventure made just for you...</p>
            <button onclick="game.start()">Start Our Journey ‚ú®</button>
            <p class="subtitle" style="margin-top: 20px; font-size: 0.8em;">
                High Score: <span id="highScore">0</span> LP üèÜ
            </p>
        </div>
        
        <!-- STORY SCREEN -->
        <div id="storyScreen" class="screen">
            <div id="storyText"></div>
            <div id="choices" class="choice-grid"></div>
        </div>
        
        <!-- MINIGAME SCREEN (instructions) -->
        <div id="gameScreen" class="screen">
            <div id="gameText"></div>
            <button onclick="game.startCurrentMinigame()">I'm Ready! üí™</button>
        </div>
        
        <!-- TYPE CHALLENGE SCREEN -->
        <div id="typeScreen" class="screen">
            <h2>üí¨ Quick! Type this: üí¨</h2>
            <p id="typePrompt" style="font-size: 2em; margin: 20px 0;"></p>
            <input type="text" id="typeInput" placeholder="Type here..." autocomplete="off">
            <p class="subtitle">Type it EXACTLY and press Enter!</p>
        </div>
        
        <!-- ENDING SCREEN -->
        <div id="endingScreen" class="screen">
            <div id="endingText"></div>
            <button onclick="game.restart()">Play Again üîÑ</button>
            <button onclick="game.share()">Share My Score üì±</button>
        </div>
    </div>

    <script>
        // ============================================
        // üéÆ GAME ENGINE
        // ============================================
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W = canvas.width = window.innerWidth;
        let H = canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        });
        
        // ============================================
        // üéµ AUDIO SYSTEM (No files needed!)
        // ============================================
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const sounds = {
            pop: (freq = 800) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            },
            
            success: () => {
                [600, 800, 1000].forEach((freq, i) => {
                    setTimeout(() => sounds.pop(freq), i * 50);
                });
            },
            
            miss: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            }
        };
        
        // ============================================
        // üíï PARTICLE & HEART RENDERING
        // ============================================
        
        class Particle {
            constructor(x, y, color = '#fff') {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = -Math.random() * 10 - 5;
                this.life = 1;
                this.size = Math.random() * 8 + 4;
                this.color = color;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.2;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.3; // gravity
                this.life -= 0.015;
                this.rotation += this.rotationSpeed;
            }
            
            draw() {
                if (this.life <= 0) return;
                ctx.globalAlpha = this.life;
                drawHeart(this.x, this.y, this.size, this.color, this.rotation);
                ctx.globalAlpha = 1;
            }
        }
        
        function drawHeart(x, y, size = 20, color = '#ff69b4', rotation = 0) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation);
            ctx.fillStyle = color;
            ctx.beginPath();
            
            const topCurveHeight = size * 0.3;
            ctx.moveTo(0, topCurveHeight);
            
            // Left half
            ctx.bezierCurveTo(
                -size / 2, -topCurveHeight,
                -size, topCurveHeight / 2,
                -size / 2, topCurveHeight + size / 2
            );
            
            // Bottom point
            ctx.lineTo(0, topCurveHeight + size);
            
            // Right half
            ctx.lineTo(size / 2, topCurveHeight + size / 2);
            ctx.bezierCurveTo(
                size, topCurveHeight / 2,
                size / 2, -topCurveHeight,
                0, topCurveHeight
            );
            
            ctx.closePath();
            ctx.fill();
            
            // Glow effect
            ctx.shadowBlur = 15;
            ctx.shadowColor = color;
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.restore();
        }
        
        // ============================================
        // üéÆ GAME STATE
        // ============================================
        
        const game = {
            state: 'title',
            lp: 0,
            highScore: parseInt(localStorage.getItem('catchingYouHighScore')) || 0,
            storyProgress: 0,
            currentMinigame: null,
            particles: [],
            achievements: [],
            userChoices: [],
            
            // Minigame entities
            clickableHearts: [],
            fallingHearts: [],
            basket: { x: W / 2, y: H - 100, size: 50, vx: 0 },
            timer: 0,
            
            init() {
                document.getElementById('highScore').textContent = this.highScore;
                this.startAnimationLoop();
                this.setupControls();
                this.spawnBackgroundHearts();
            },
            
            start() {
                this.lp = 0;
                this.storyProgress = 0;
                this.userChoices = [];
                this.updateScore();
                this.showScreen('storyScreen');
                this.showStory(0);
            },
            
            restart() {
                location.reload();
            },
            
            share() {
                const text = `I scored ${this.lp} Love Points in "Catching You"! üíñ Best birthday game ever! üéÇ`;
                if (navigator.share) {
                    navigator.share({ text });
                } else {
                    alert('Copy this:\n\n' + text);
                }
            },
            
            updateScore() {
                document.getElementById('lpScore').textContent = this.lp;
                if (this.lp > this.highScore) {
                    this.highScore = this.lp;
                    localStorage.setItem('catchingYouHighScore', this.highScore);
                }
            },
            
            addLP(amount, reason = '') {
                this.lp += amount;
                this.updateScore();
                if (amount > 0) sounds.pop(800 + amount * 10);
                
                // Check achievements
                if (this.lp >= 50 && !this.achievements.includes('halfCentury')) {
                    this.showAchievement('üí∞ 50 Love Points! You\'re on fire!');
                    this.achievements.push('halfCentury');
                }
                if (this.lp >= 100 && !this.achievements.includes('century')) {
                    this.showAchievement('üèÜ 100 LP! LEGENDARY LOVER! üèÜ');
                    this.achievements.push('century');
                    this.addLP(20); // Bonus!
                }
            },
            
            showAchievement(text) {
                const achDiv = document.getElementById('achievement');
                achDiv.textContent = text;
                achDiv.style.display = 'block';
                sounds.success();
                setTimeout(() => {
                    achDiv.style.display = 'none';
                }, 3000);
            },
            
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },
            
            setInstructions(text) {
                document.getElementById('instructions').innerHTML = text;
            },
            
            // ============================================
            // üìñ STORY SYSTEM
            // ============================================
            
            showStory(index) {
                // üé® EDIT HERE: Customize your story!
                const stories = [
                    {
                        text: `<h2>üåÖ Chapter 1: The Beginning</h2>
                               <p>You're walking through our favorite park where we first met...</p>
                               <p>The sunset paints the sky in beautiful colors, just like that perfect day.</p>
                               <p>What do you do, my love?</p>`,
                        choices: [
                            { text: 'üíê Pick flowers for me', lp: 10, nextGame: 'click' },
                            { text: 'üíã Steal a kiss under the tree', lp: 15, nextGame: 'click' },
                            { text: 'üéµ Play our song on your phone', lp: 12, nextGame: 'click' },
                            { text: 'üòè Challenge me to a race', lp: 8, nextGame: 'click' }
                        ]
                    },
                    {
                        text: `<h2>‚≠ê Chapter 2: The Dance</h2>
                               <p>As the stars come out, we start dancing...</p>
                               <p>But wait! My heart is literally floating away! üò±</p>
                               <p>You need to catch it before it's gone!</p>`,
                        choices: [
                            { text: 'üèÉ‚Äç‚ôÄÔ∏è Chase it! Let\'s go!', lp: 0, nextGame: 'catch' }
                        ]
                    },
                    {
                        text: `<h2>üí´ Chapter 3: The Challenge</h2>
                               <p>Amazing catch! You always know how to hold my heart ü•∞</p>
                               <p>But now... one final test!</p>
                               <p>What will you promise me?</p>`,
                        choices: [
                            { text: 'üíç Forever and always', lp: 20, nextGame: 'type' },
                            { text: 'üåü Every adventure together', lp: 18, nextGame: 'type' },
                            { text: 'üòÇ All the chaos and laughs', lp: 15, nextGame: 'type' },
                            { text: 'üåπ Endless love and surprises', lp: 22, nextGame: 'type' }
                        ]
                    }
                ];
                
                if (index >= stories.length) {
                    this.showEnding();
                    return;
                }
                
                const story = stories[index];
                document.getElementById('storyText').innerHTML = story.text;
                
                const choicesDiv = document.getElementById('choices');
                choicesDiv.innerHTML = '';
                
                story.choices.forEach((choice, i) => {
                    const btn = document.createElement('button');
                    btn.textContent = choice.text;
                    btn.onclick = () => {
                        this.addLP(choice.lp);
                        this.userChoices.push(i);
                        this.storyProgress++;
                        
                        // Random surprise event!
                        if (Math.random() < 0.3) {
                            this.surpriseEvent();
                        }
                        
                        this.prepareMinigame(choice.nextGame);
                    };
                    choicesDiv.appendChild(btn);
                });
                
                this.setInstructions('üí≠ Choose your path...');
            },
            
            surpriseEvent() {
                const events = [
                    { text: '‚ú® A shooting star! +10 LP!', lp: 10 },
                    { text: 'ü¶ã A butterfly lands on your hand! +8 LP!', lp: 8 },
                    { text: 'üåπ You found a hidden rose! +12 LP!', lp: 12 },
                    { text: 'üí´ Our song plays nearby! +15 LP!', lp: 15 }
                ];
                const event = events[Math.floor(Math.random() * events.length)];
                this.showAchievement(event.text);
                this.addLP(event.lp);
            },
            
            // ============================================
            // üéÆ MINIGAME SYSTEM
            // ============================================
            
            prepareMinigame(gameType) {
                this.currentMinigame = gameType;
                this.showScreen('gameScreen');
                
                const instructions = {
                    click: `<h2>üíï Quick Reflexes!</h2>
                            <p>Hearts will appear on screen...</p>
                            <p><strong>TAP/CLICK them before they fade!</strong></p>
                            <p>Fast clicks = More Love Points! ‚ö°</p>`,
                    catch: `<h2>üß∫ Catch My Heart!</h2>
                            <p>Hearts are falling from the sky!</p>
                            <p><strong>Move left/right to catch them!</strong></p>
                            <p>üñ±Ô∏è Mouse/Touch: Just move around<br>‚å®Ô∏è Keyboard: Arrow keys or A/D</p>`,
                    type: `<h2>üí¨ Speak From The Heart!</h2>
                            <p>One final challenge to prove your love...</p>
                            <p><strong>Type exactly what appears!</strong></p>
                            <p>Fast and accurate = Mega points! üî•</p>`
                };
                
                document.getElementById('gameText').innerHTML = instructions[gameType];
            },
            
            startCurrentMinigame() {
                this.setInstructions('');
                this.showScreen('ui'); // Hide all screens
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                
                switch(this.currentMinigame) {
                    case 'click':
                        this.startClickGame();
                        break;
                    case 'catch':
                        this.startCatchGame();
                        break;
                    case 'type':
                        this.startTypeGame();
                        break;
                }
            },
            
            // ============================================
            // üéØ MINIGAME 1: Click Hearts
            // ============================================
            
            startClickGame() {
                this.state = 'clickGame';
                this.clickableHearts = [];
                this.timer = 15; // 15 seconds
                document.getElementById('timer').classList.remove('hidden');
                
                const spawnHeart = () => {
                    if (this.state !== 'clickGame') return;
                    
                    this.clickableHearts.push({
                        x: Math.random() * (W - 100) + 50,
                        y: Math.random() * (H - 100) + 50,
                        size: 25 + Math.random() * 20,
                        life: 1,
                        maxLife: 0.8 + Math.random() * 0.5, // Random fade speed!
                        color: ['#ff69b4', '#ff1493', '#ff69b4', '#ffc0cb'][Math.floor(Math.random() * 4)],
                        rotation: Math.random() * Math.PI * 2,
                        pulse: 1
                    });
                    
                    setTimeout(spawnHeart, 600 + Math.random() * 800);
                };
                
                spawnHeart();
                this.setInstructions('üíï TAP THE HEARTS! üíï');
            },
            
            clickHeart(x, y) {
                if (this.state !== 'clickGame') return;
                
                for (let i = this.clickableHearts.length - 1; i >= 0; i--) {
                    const heart = this.clickableHearts[i];
                    const dist = Math.hypot(x - heart.x, y - heart.y);
                    
                    if (dist < heart.size && heart.life > 0.2) {
                        // Success!
                        const points = Math.ceil(5 + (heart.life * 10)); // More points for fast clicks
                        this.addLP(points);
                        
                        // Particle explosion
                        for (let j = 0; j < 8; j++) {
                            this.particles.push(new Particle(heart.x, heart.y, heart.color));
                        }
                        
                        sounds.pop(1000 + points * 20);
                        this.clickableHearts.splice(i, 1);
                        break;
                    }
                }
            },
            
            // ============================================
            // üß∫ MINIGAME 2: Catch Hearts
            // ============================================
            
            startCatchGame() {
                this.state = 'catchGame';
                this.fallingHearts = [];
                this.basket.x = W / 2;
                this.basket.vx = 0;
                this.timer = 25; // 25 seconds
                document.getElementById('timer').classList.remove('hidden');
                
                const spawnFalling = () => {
                    if (this.state !== 'catchGame') return;
                    
                    this.fallingHearts.push({
                        x: Math.random() * W,
                        y: -30,
                        vy: 3 + Math.random() * 3,
                        size: 20 + Math.random() * 15,
                        rotation: Math.random() * Math.PI * 2,
                        rotSpeed: (Math.random() - 0.5) * 0.1,
                        color: ['#ff69b4', '#ff1493', '#ffc0cb'][Math.floor(Math.random() * 3)]
                    });
                    
                    setTimeout(spawnFalling, 400 + Math.random() * 600);
                };
                
                spawnFalling();
                this.setInstructions('üß∫ CATCH THEM ALL! Use mouse/touch/arrows üß∫');
            },
            
            updateCatchGame() {
                // Update basket position
                this.basket.x += this.basket.vx;
                this.basket.x = Math.max(50, Math.min(W - 50, this.basket.x));
                this.basket.vx *= 0.9; // Friction
                
                // Update falling hearts
                for (let i = this.fallingHearts.length - 1; i >= 0; i--) {
                    const heart = this.fallingHearts[i];
                    heart.y += heart.vy;
                    heart.rotation += heart.rotSpeed;
                    
                    // Check collision with basket
                    if (heart.y > this.basket.y - 40 && 
                        heart.y < this.basket.y + 20 &&
                        Math.abs(heart.x - this.basket.x) < 50) {
                        
                        this.addLP(5);
                        for (let j = 0; j < 5; j++) {
                            this.particles.push(new Particle(heart.x, heart.y, heart.color));
                        }
                        sounds.pop(1000);
                        this.fallingHearts.splice(i, 1);
                    } else if (heart.y > H + 30) {
                        this.fallingHearts.splice(i, 1);
                    }
                }
                
                // Draw basket
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üß∫', this.basket.x, this.basket.y);
            },
            
            // ============================================
            // ‚å®Ô∏è MINIGAME 3: Type Challenge
            // ============================================
            
            startTypeGame() {
                this.state = 'typeGame';
                this.showScreen('typeScreen');
                
                // üé® EDIT HERE: Add your own phrases!
                const phrases = [
                    'I LOVE YOU',
                    'FOREVER',
                    'YOU AND ME',
                    'BEST DAY EVER',
                    'HAPPY BIRTHDAY',
                    'MY EVERYTHING',
                    'ALWAYS'
                ];
                
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                document.getElementById('typePrompt').textContent = phrase;
                
                const input = document.getElementById('typeInput');
                input.value = '';
                input.focus();
                
                const startTime = Date.now();
                
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        const typed = input.value.trim().toUpperCase();
                        const timeSpent = (Date.now() - startTime) / 1000;
                        
                        if (typed === phrase) {
                            // Perfect!
                            const speedBonus = Math.max(0, Math.floor(20 - timeSpent));
                            this.addLP(20 + speedBonus);
                            sounds.success();
                            this.showAchievement(`üíØ PERFECT! +${20 + speedBonus} LP!`);
                            
                            // Mega confetti
                            for (let i = 0; i < 50; i++) {
                                this.particles.push(new Particle(
                                    Math.random() * W,
                                    Math.random() * H,
                                    ['#FFD700', '#ff69b4', '#00ffff'][Math.floor(Math.random() * 3)]
                                ));
                            }
                            
                            setTimeout(() => {
                                this.storyProgress++;
                                this.showStory(this.storyProgress);
                            }, 2000);
                        } else {
                            // Close enough?
                            const similarity = this.calculateSimilarity(typed, phrase);
                            if (similarity > 0.7) {
                                this.addLP(10);
                                this.showAchievement('üòÖ Close enough! +10 LP');
                                sounds.pop();
                                setTimeout(() => {
                                    this.storyProgress++;
                                    this.showStory(this.storyProgress);
                                }, 2000);
                            } else {
                                sounds.miss();
                                input.value = '';
                                this.setInstructions('‚ùå Try again! Type it exactly!');
                            }
                        }
                    }
                };
                
                this.setInstructions('‚å®Ô∏è Type it EXACTLY and press Enter! ‚å®Ô∏è');
            },
            
            calculateSimilarity(s1, s2) {
                let matches = 0;
                const len = Math.min(s1.length, s2.length);
                for (let i = 0; i < len; i++) {
                    if (s1[i] === s2[i]) matches++;
                }
                return matches / Math.max(s1.length, s2.length);
            },
            
            // ============================================
            // üèÜ ENDING SYSTEM
            // ============================================
            
            showEnding() {
                this.state = 'ending';
                this.showScreen('endingScreen');
                document.getElementById('timer').classList.add('hidden');
                
                // Calculate ending based on LP and choices
                let ending = {};
                
                // üé® EDIT HERE: Customize endings!
                if (this.lp >= 150) {
                    ending = {
                        title: 'üíç SOULMATE STATUS ACHIEVED üíç',
                        text: `<p><strong>WOW.</strong> You scored <span style="font-size: 2em; color: #FFD700;">${this.lp} LP</span>! üèÜ</p>
                               <p>You didn't just catch my heart... you caught my SOUL. ü•∫</p>
                               <p>Every moment with you is magic.</p>
                               <p>Happy Birthday to the love of my life! üíñ</p>
                               <p><em>Fun fact: You're the reason I smile every day.</em> üòä</p>`,
                        emoji: 'üíïüíç‚ú®'
                    };
                } else if (this.lp >= 100) {
                    ending = {
                        title: 'üî• LEGENDARY LOVE üî•',
                        text: `<p>Amazing! You scored <span style="font-size: 2em; color: #ff69b4;">${this.lp} LP</span>! üíï</p>
                               <p>You really know how to make my heart race! ‚ù§Ô∏è</p>
                               <p>Can't wait for more adventures together.</p>
                               <p>Happy Birthday, beautiful! üéÇ</p>`,
                        emoji: 'üòòüíñüéâ'
                    };
                } else if (this.lp >= 60) {
                    ending = {
                        title: 'üíù SWEETHEART VIBES üíù',
                        text: `<p>You got <span style="font-size: 2em; color: #ffc0cb;">${this.lp} LP</span>! üéà</p>
                               <p>You're still learning to catch me, huh? üòè</p>
                               <p>That's okay, we have forever to practice!</p>
                               <p>Happy Birthday, cutie! üíï</p>`,
                        emoji: 'ü•∞üíïüéÇ'
                    };
                } else {
                    ending = {
                        title: 'üòÇ CHAOTIC LOVE üòÇ',
                        text: `<p>You scored <span style="font-size: 2em;">${this.lp} LP</span>! üòÖ</p>
                               <p>My heart was TOO slippery for you today!</p>
                               <p>But that's okay... I love our chaos! üíÄ</p>
                               <p>Try again? I dare you! üòè</p>
                               <p>Happy Birthday anyway, troublemaker! üòÇüéÇ</p>`,
                        emoji: 'üòúüíïüòÇ'
                    };
                }
                
                document.getElementById('endingText').innerHTML = `
                    <h1>${ending.emoji}</h1>
                    <h2>${ending.title}</h2>
                    ${ending.text}
                    <p style="margin-top: 30px; font-size: 0.9em; opacity: 0.8;">
                        üíù Made with endless love just for you üíù
                    </p>
                    <p style="font-size: 0.8em; opacity: 0.6;">
                        High Score: ${this.highScore} LP
                    </p>
                `;
                
                // MEGA CONFETTI EXPLOSION
                for (let i = 0; i < 100; i++) {
                    setTimeout(() => {
                        this.particles.push(new Particle(
                            Math.random() * W,
                            -50,
                            ['#FFD700', '#ff69b4', '#00ffff', '#ff1493', '#ffc0cb'][Math.floor(Math.random() * 5)]
                        ));
                    }, i * 20);
                }
                
                sounds.success();
            },
            
            // ============================================
            // üé® RENDERING & ANIMATION
            // ============================================
            
            spawnBackgroundHearts() {
                setInterval(() => {
                    if (this.state === 'title' || this.state.includes('story')) {
                        if (Math.random() < 0.3) {
                            this.particles.push(new Particle(
                                Math.random() * W,
                                -20,
                                'rgba(255, 255, 255, 0.3)'
                            ));
                        }
                    }
                }, 200);
            },
            
            startAnimationLoop() {
                const animate = () => {
                    ctx.clearRect(0, 0, W, H);
                    
                    // Update and draw particles
                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        this.particles[i].update();
                        this.particles[i].draw();
                        if (this.particles[i].life <= 0) {
                            this.particles.splice(i, 1);
                        }
                    }
                    
                    // Game-specific rendering
                    if (this.state === 'clickGame') {
                        // Update clickable hearts
                        for (let i = this.clickableHearts.length - 1; i >= 0; i--) {
                            const heart = this.clickableHearts[i];
                            heart.life -= 0.01;
                            heart.pulse = 1 + Math.sin(Date.now() * 0.01) * 0.1;
                            
                            if (heart.life <= 0) {
                                this.clickableHearts.splice(i, 1);
                            } else {
                                ctx.globalAlpha = heart.life;
                                drawHeart(heart.x, heart.y, heart.size * heart.pulse, heart.color, heart.rotation);
                                ctx.globalAlpha = 1;
                            }
                        }
                    } else if (this.state === 'catchGame') {
                        this.updateCatchGame();
                        
                        // Draw falling hearts
                        this.fallingHearts.forEach(heart => {
                            drawHeart(heart.x, heart.y, heart.size, heart.color, heart.rotation);
                        });
                    }
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
                
                // Timer countdown
                setInterval(() => {
                    if (this.state === 'clickGame' || this.state === 'catchGame') {
                        this.timer -= 0.1;
                        document.getElementById('timeLeft').textContent = Math.ceil(this.timer);
                        
                        if (this.timer <= 0) {
                            // End minigame
                            if (this.state === 'clickGame' || this.state === 'catchGame') {
                                document.getElementById('timer').classList.add('hidden');
                                this.storyProgress++;
                                setTimeout(() => {
                                    this.showStory(this.storyProgress);
                                }, 500);
                            }
                        }
                    }
                }, 100);
            },
            
            // ============================================
            // üéÆ CONTROLS
            // ============================================
            
            setupControls() {
                // Mouse/Touch for clicking hearts
                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    return {
                        x: (clientX - rect.left) * (W / rect.width),
                        y: (clientY - rect.top) * (H / rect.height)
                    };
                };
                
                canvas.addEventListener('click', (e) => {
                    const pos = getPos(e);
                    this.clickHeart(pos.x, pos.y);
                });
                
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const pos = getPos(e);
                    this.clickHeart(pos.x, pos.y);
                }, { passive: false });
                
                // Mouse/Touch move for basket
                canvas.addEventListener('mousemove', (e) => {
                    if (this.state === 'catchGame') {
                        const pos = getPos(e);
                        this.basket.x = pos.x;
                    }
                });
                
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.state === 'catchGame') {
                        const pos = getPos(e);
                        this.basket.x = pos.x;
                    }
                }, { passive: false });
                
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (this.state === 'catchGame') {
                        if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                            this.basket.vx = -15;
                        }
                        if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                            this.basket.vx = 15;
                        }
                    }
                    
                    if (e.key === ' ' && this.state === 'title') {
                        this.start();
                    }
                });
                
                // Spacebar to start
                document.addEventListener('keypress', (e) => {
                    if (e.key === ' ' && this.state === 'title') {
                        e.preventDefault();
                        this.start();
                    }
                });
            }
        };
        
        // ============================================
        // üöÄ INITIALIZE GAME
        // ============================================
        
        window.addEventListener('load', () => {
            game.init();
        });
        
    </script>
</body>
</html>
